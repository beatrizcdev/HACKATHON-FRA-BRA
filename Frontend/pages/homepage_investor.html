<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Homepage_investidor</title>
    <link rel="stylesheet" href="../style.css" />
  </head>
  <body class="investidor_body">
    <header
      class="site_header"
      style="
        display: flex;
        align-items: center;
        gap: 60px;
        padding: 12px 18px;
      "
    >
      <a href="../index.html" class="logo_link" aria-label="In√≠cio">
        <img
          src="../pictures/logotipo.svg"
          alt="logotipo"
          style="height: 36px;
          padding: 10px;
          "
        />
      </a>
      <a class="botoesHeader" href="./homepage_investor.html">Benef√≠cios</a>
      <a class="botoesHeader" href="./proposta.html">Propostas</a>
      <div id="div-perfil">
        <nav>
        <a
          href="investidor_perfil.html"
          class="header_profile_button"
        >
          <img id="foto-perfil" src="../pictures/perfil.png" alt="" 
          style="
          height: 30px;">
        </a>
      </nav>
      </div>
      
    </header>

    <main class="investidor_conteudo">
      <h1 class="investidor_titulo">Edital de Retrofit ‚Äî Invista e Lucre</h1>
      <p class="investidor_descricao">
        A plataforma <strong>Centro Vivo</strong> incentiva a revitaliza√ß√£o urbana
        em √°reas como <strong>Boa Viagem</strong> e Santo Ant√¥nio. Ao investir
        em retrofit, voc√™ recebe benef√≠cios fiscais, valoriza√ß√£o imobili√°ria e
        retorno econ√¥mico sustent√°vel.
      </p>

      <section class="investidor_beneficios">
        <div class="investidor_beneficio">
          Isen√ß√£o de IPTU e incentivos fiscais
        </div>
        <div class="investidor_beneficio">
          Aproveitamento m√°ximo do potencial construtivo
        </div>
        <div class="investidor_beneficio">
          Acesso facilitado a linhas de cr√©dito e programas p√∫blicos
        </div>
        <div class="investidor_beneficio">
          Aumento direto no valor de mercado do im√≥vel
        </div>
      </section>

      <section class="investidor_calculadora">
        <h2>Calcule seu Lucro Potencial</h2>
        <form class="investidor_form" id="formLucro">
          <label for="area">√Årea do edif√≠cio (m¬≤):</label>
          <input type="number" id="area" placeholder="Ex: 500" />

          <label for="zona">Zona de investimento:</label>
          <select id="zona">
            <option value="boa_viagem">Boa Viagem</option>
            <option value="santo_antonio">Santo Ant√¥nio</option>
          </select>

          <button type="button" onclick="calcularLucro()">Calcular</button>
        </form>

        <div
          id="resultado"
          class="investidor_resultado"
          style="display: none"
        ></div>
      </section>

      <!-- NOVO: bot√£o para inserir proposta -->
      <section style="margin-top: 24px">
        <button
          id="btnAddProposta"
          style="display: flex; align-items: center; justify-self: center; gap: 4px; padding: 20px 24px; border-radius: 30px; cursor: pointer; background-color:#EDC16A; color: #000; font-size: 20px; font-weight: bold; margin-top: 100px;  margin-bottom: 100px; " 
        ><img src="../pictures/botaoAdd.png" alt="bot√£o adicionar" id="imagem-add"style="height: 4vh;">
          ADICIONAR NOVA PROPOSTA
        </button>
      </section>
    </main>

    <script>
      function calcularLucro() {
        const area = Number(document.getElementById("area").value);
        const zona = document.getElementById("zona").value;
        let valor_m2 = zona === "boa_viagem" ? 12000 : 9000; // exemplo

        if (!area) {
          alert("Informe a √°rea do edif√≠cio!");
          return;
        }

        const lucro = area * valor_m2 * 0.2; // sup√µe 20% de rentabilidade
        const potencial = area * 1.5; // aumento do potencial construtivo

        document.getElementById("resultado").style.display = "block";
        document.getElementById("resultado").innerHTML = `
        üí∞ Lucro estimado: <strong>R$ ${lucro.toLocaleString()}</strong><br>
        üèóÔ∏è Potencial construtivo: <strong>${potencial.toLocaleString()} m¬≤</strong>
      `;
      }

      // Modal de inserir proposta
      (function () {
        const API_BASE = "http://localhost:3000"; // ajuste se necess√°rio
        const btn = document.getElementById("btnAddProposta");
        if (!btn) return;

        btn.addEventListener("click", openFormModal);

        function openFormModal() {
          const overlay = document.createElement("div");
          overlay.style =
            "position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999;";
          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) overlay.remove();
          });

          const box = document.createElement("div");
          box.style =
            "background:#fff;padding:18px;border-radius:8px;max-width:520px;width:94%;box-shadow:0 8px 30px rgba(0,0,0,0.2);max-height:90vh;overflow:auto;";
          box.innerHTML = `
          <button id="closeForm" aria-label="Fechar" style="float:right;border:none;background:none;font-size:18px;cursor:pointer;">‚úï</button>
          <h2 style="margin-top:0">Nova Proposta</h2>
          <form id="formProposta" style="display:flex;flex-direction:column;gap:8px;">
            <label>Usos (t√≠tulo)</label>
            <input name="usos" type="text" required placeholder="Ex: Centro cultural e biblioteca">
            <label>Contrapartida</label>
            <textarea name="contrapartida" rows="3" placeholder="Descreva a contrapartida" required></textarea>
            <label>Fachada ativa</label>
            <input type="checkbox" name="fachada_ativa">
            <label>Tombamento</label>
            <input type="checkbox" name="tombamento">
            <label>P√∫blico</label>
            <select name="publico" required>
              <option value="">-- selecione --</option>
              <option value="geral">Geral</option>
              <option value="governo">Governo</option>
            </select>
            <label>Usu√°rio (id) ‚Äî opcional</label>
            <input name="usuarioId" type="number" placeholder="Id do usu√°rio (se aplic√°vel)">
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
              <button type="button" id="cancelForm" style="padding:8px 12px;">Cancelar</button>
              <button type="submit" style="padding:8px 12px;">Salvar</button>
            </div>
          </form>
        `;
          overlay.appendChild(box);
          document.body.appendChild(overlay);

          box
            .querySelector("#closeForm")
            .addEventListener("click", () => overlay.remove());
          box
            .querySelector("#cancelForm")
            .addEventListener("click", () => overlay.remove());

          const form = box.querySelector("#formProposta");
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const usos = String(formData.get("usos") || "").trim();
            const contrapartida = String(
              formData.get("contrapartida") || ""
            ).trim();
            const fachada_ativa =
              formData.get("fachada_ativa") === "on" ||
              form.querySelector('[name="fachada_ativa"]').checked;
            const tombamento =
              formData.get("tombamento") === "on" ||
              form.querySelector('[name="tombamento"]').checked;
            const publico = String(formData.get("publico") || "").toLowerCase();
            const usuarioIdRaw = formData.get("usuarioId");
            const usuarioId = usuarioIdRaw ? Number(usuarioIdRaw) : null;

            if (!usos) {
              alert('Campo "Usos" obrigat√≥rio');
              return;
            }
            if (!["geral", "governo"].includes(publico)) {
              alert("Selecione um p√∫blico v√°lido");
              return;
            }

            const payload = {
              usos,
              contrapartida,
              fachada_ativa: Boolean(fachada_ativa),
              publico,
              tombamento: Boolean(tombamento),
              usuarioId,
            };

            try {
              const resp = await fetch(`${API_BASE}/propostas`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (resp.ok) {
                alert("Proposta enviada com sucesso");
                overlay.remove();
              } else {
                const err = await resp.json().catch(() => null);
                alert(
                  "Erro ao enviar proposta: " +
                    (err && err.error ? err.error : resp.statusText)
                );
              }
            } catch (err) {
              console.error(err);
              alert("Erro de conex√£o ao enviar proposta");
            }
          });
        }
      })();
    </script>
  </body>
</html>
